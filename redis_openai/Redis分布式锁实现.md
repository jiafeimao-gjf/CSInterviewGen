# é—®é¢˜ï¼šRedisåˆ†å¸ƒå¼é”å®ç°
å›ç­”å¦‚ä¸‹ï¼š
ã€ŒRedisåˆ†å¸ƒå¼é”å®ç°ã€ è¯·æ ¹æ®ä»¥ä¸‹å†…å®¹ï¼š
ä½¿ç”¨setnxå‘½ä»¤å®ç°åˆ†å¸ƒå¼é”ï¼Œè®¾ç½®keyæ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ã€‚é€šè¿‡Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼Œé¿å…æ­»é”ã€‚ä¾‹å¦‚ï¼šSET resource_name my_random_value NX PX 30000ã€‚
 ç»†åŒ–å›ç­”: 
 è¦æ±‚ï¼š1. å›ç­”è¦è¯¦ç»†ï¼Œå†…å®¹ä¸°å¯Œï¼Œå®è·µä¸ç†è®ºç»“åˆï¼2. é‡‡ç”¨æ€»åˆ†æ€»çš„æ–‡ç« æ€è·¯ï¼3ã€é€‚å½“è¿›è¡Œå›¾ç¤ºè¯´æ˜## Redis åˆ†å¸ƒå¼é”å®ç°ï¼ˆSETNX + Lua è„šæœ¬ï¼‰  
**ç›®æ ‡**ï¼šç”¨æœ€åŸå§‹ã€æœ€é€šç”¨çš„æ–¹å¼å®ç°å¯é çš„åˆ†å¸ƒå¼é”ï¼Œæ—¢èƒ½é¿å…æ­»é”ï¼Œåˆèƒ½ä¿è¯åŸå­æ€§ã€‚  
**æ–¹æ³•**ï¼š  
1. ä½¿ç”¨ `SET key value NX PX timeout`ï¼ˆç­‰ä»·äº `SETNX` + `EXPIRE`ï¼‰åˆ›å»ºé”ã€‚  
2. é‡‡ç”¨ Lua è„šæœ¬å®ç° **åŠ é”** ä¸ **è§£é”** çš„åŸå­æ“ä½œï¼Œé˜²æ­¢è§£é”æ—¶å‡ºç°ç«äº‰ã€‚  

ä¸‹é¢æŒ‰â€œ**æ€»â€“åˆ†â€“æ€»**â€çš„æ–‡ç« ç»“æ„å±•å¼€ï¼Œé…åˆæ–‡å­—è¯´æ˜ä¸æµç¨‹å›¾ï¼Œå¸®åŠ©ä½ ä»ç†è®ºåˆ°å®è·µä¸€ç½‘æ‰“å°½ã€‚  

---

## 1ï¸âƒ£ æ€»è§ˆï¼šä¸ºä»€ä¹ˆè¦ç”¨ Redis åšåˆ†å¸ƒå¼é”ï¼Ÿ

| éœ€æ±‚ | ä¼ ç»Ÿæ–¹æ¡ˆ | Redis æ–¹æ¡ˆ |
|------|----------|------------|
| **åŸå­æ€§** | éœ€è¦å¤šå°æœºå™¨åè°ƒï¼Œå¤æ‚ | å•æ¡ `SET NX PX` å·²åŸå­ |
| **æ€§èƒ½** | é€šå¸¸é˜»å¡å¼é”æ…¢ | é«˜ååã€å†…å­˜æ“ä½œ |
| **å¯æ‰©å±•æ€§** | å—é™äºä¸­å¿ƒåŒ–æœåŠ¡ | é›†ç¾¤ã€Sentinel ç­‰å¯æ°´å¹³æ‰©å±• |
| **å¯é æ€§** | éœ€è‡ªè¡Œä¿è¯ | å†…ç½®è¿‡æœŸã€å•æœºå®¹é”™ |
| **æ˜“ç”¨æ€§** | éœ€è¦è‡ªå·±å®ç°åˆ†å¸ƒå¼é€»è¾‘ | åªéœ€ä¸€è¡Œå‘½ä»¤æˆ–è„šæœ¬ |

> **æ ¸å¿ƒä¼˜åŠ¿**ï¼šä¸€æ¡ `SET` å‘½ä»¤å°±èƒ½å®Œæˆâ€œé”å®š + è¿‡æœŸâ€ï¼Œå¹¶ä¸”æ˜¯åŸå­æ‰§è¡Œï¼Œå¤©ç„¶é¿å…äº†â€œåŠ é”åç¨‹åºå¼‚å¸¸å¯¼è‡´æ­»é”â€ã€‚

---

## 2ï¸âƒ£ ç»†åˆ†ï¼šåˆ†å¸ƒå¼é”çš„å®Œæ•´å®ç°

### 2.1 å…ˆå†³æ¡ä»¶

| æ¡ä»¶ | è¯´æ˜ |
|------|------|
| **å”¯ä¸€æ ‡è¯†** | æ¯ä¸ªè¿›ç¨‹åœ¨ç”³è¯·é”æ—¶éƒ½éœ€è¦ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„éšæœºå­—ç¬¦ä¸²ï¼ˆå¦‚ UUIDï¼‰ã€‚ |
| **è¿‡æœŸæ—¶é—´** | é”çš„æŒæœ‰æ—¶é—´ä¸å®œè¿‡é•¿ï¼Œé€šå¸¸ 30 ç§’ä»¥å†…ï¼Œé˜²æ­¢ä¸šåŠ¡è¶…æ—¶åé”æœªé‡Šæ”¾ã€‚ |
| **å¿ƒè·³ / è‡ªåŠ¨ç»­æœŸ** | å¯¹äºé•¿ä»»åŠ¡å¯åœ¨ä¸šåŠ¡å±‚æ‰‹åŠ¨ `PEXPIRE` ç»­æœŸï¼Œæˆ–ä½¿ç”¨ä¸“é—¨çš„â€œç»­æœŸçº¿ç¨‹â€ã€‚ |

### 2.2 åŠ é”ï¼ˆAcquireï¼‰

#### 2.2.1 ä¼ ç»Ÿ `SETNX + EXPIRE`ï¼ˆä¸æ¨èï¼‰

```bash
SET key value NX EX 30   # 30 ç§’è¿‡æœŸ
```

> **é—®é¢˜**ï¼šå¦‚æœä¸šåŠ¡è¿›ç¨‹åœ¨ `SETNX` æˆåŠŸåçªç„¶å´©æºƒï¼Œé”å°±ä¼šå› è¿‡æœŸè‡ªåŠ¨é‡Šæ”¾ï¼Œå¯¼è‡´ **æ­»é”**ã€‚å¦‚æœä¸šåŠ¡åœ¨ `EXPIRE` åå´©æºƒï¼Œé”ä¼šä¸€ç›´å ç”¨ï¼Œäº§ç”Ÿ **è¯¯è§£é”**ã€‚

#### 2.2.2 åŸå­åŠ é”è„šæœ¬

```lua
-- KEYS[1] -> lock_key
-- ARGV[1] -> unique_value
-- ARGV[2] -> expire_ms

if redis.call('set', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) then
    return 1
else
    return 0
end
```

**è°ƒç”¨ç¤ºä¾‹ï¼ˆPythonï¼‰**

```python
import redis, uuid, time

r = redis.StrictRedis(host='127.0.0.1', port=6379)
lock_key = 'my_resource_lock'
unique_val = str(uuid.uuid4())
expire_ms = 30000  # 30 ç§’

acquired = r.eval(
    """
    if redis.call('set', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) then
        return 1
    else
        return 0
    end
    """,
    1,
    lock_key,
    unique_val,
    expire_ms
)

if acquired == 1:
    print('Lock acquired')
else:
    print('Lock not acquired')
```

> **ä¼˜ç‚¹**ï¼š  
> - å•æ¡è„šæœ¬ä¿è¯ `SET` ä¸ `EXPIRE` çš„åŸå­æ€§ã€‚  
> - å¦‚æœè„šæœ¬è¿”å› 1ï¼Œè¡¨ç¤ºé”æˆåŠŸè·å–ï¼›å¦åˆ™è¡¨ç¤ºå·²æœ‰å…¶ä»–è¿›ç¨‹æŒæœ‰ã€‚  

### 2.3 è§£é”ï¼ˆReleaseï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š**åªèƒ½é‡Šæ”¾è‡ªå·±æŒæœ‰çš„é”**ã€‚  
ä½¿ç”¨ Lua è„šæœ¬å…ˆåˆ¤æ–­ `GET` çš„å€¼æ˜¯å¦ç­‰äºæœ¬æœºç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ï¼Œè‹¥ç›¸åŒåˆ™æ‰§è¡Œ `DEL`ï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚

```lua
-- KEYS[1] -> lock_key
-- ARGV[1] -> unique_value

if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('del', KEYS[1])
else
    return 0
end
```

**è°ƒç”¨ç¤ºä¾‹ï¼ˆPythonï¼‰**

```python
released = r.eval(
    """
    if redis.call('get', KEYS[1]) == ARGV[1] then
        return redis.call('del', KEYS[1])
    else
        return 0
    end
    """,
    1,
    lock_key,
    unique_val
)

if released == 1:
    print('Lock released')
else:
    print('Cannot release lock: not owner')
```

> **å…³é”®ç‚¹**  
> - `GET` ä¸ `DEL` åœ¨åŒä¸€ä¸ªè„šæœ¬å†…åŸå­æ‰§è¡Œï¼Œé¿å…äº† â€œå…ˆè¯»å–å†åˆ é™¤â€ æœŸé—´é”è¢«ä»–äººæŠ¢å ã€‚  
> - é€šè¿‡æ£€æŸ¥ `unique_val`ï¼Œé˜²æ­¢è¯¯è§£é”ï¼šå³ä½¿é”è¿‡æœŸè¢«è‡ªåŠ¨åˆ é™¤ï¼Œåˆ«äººçš„è„šæœ¬ä¹Ÿæ— æ³•è¯¯åˆ ã€‚

### 2.4 æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client A   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  1. ç”Ÿæˆ unique_val
  2. CALL lua_acquire(lock_key, unique_val, 30000)
        â”‚
        â”œâ”€â–º æˆåŠŸ â†’ lock_key å­˜åœ¨ unique_valï¼Œè¿‡æœŸæ—¶é—´ 30s
        â”‚
        â–¼
 3. æ‰§è¡Œä¸šåŠ¡
 4. CALL lua_release(lock_key, unique_val)
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client B   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  1. ç”Ÿæˆ unique_val
  2. CALL lua_acquire(lock_key, unique_val, 30000)
        â”‚
        â”œâ”€â–º å¤±è´¥ â†’ ç»§ç»­é‡è¯•æˆ–æ”¾å¼ƒ
```

> **è¯´æ˜**ï¼š  
> - åªè¦ä¸šåŠ¡æ­£å¸¸é€€å‡ºï¼Œè„šæœ¬ä¼šä¿è¯ `DEL` æˆåŠŸã€‚  
> - è‹¥ä¸šåŠ¡å¼‚å¸¸é€€å‡ºï¼Œé”ä¼šåœ¨ 30 ç§’åè‡ªåŠ¨è¿‡æœŸï¼Œé˜²æ­¢æ­»é”ã€‚

### 2.5 è¿›é˜¶ï¼šé‡è¯•ç­–ç•¥ & è¿‡æœŸç»­æœŸ

- **é‡è¯•**ï¼šä½¿ç”¨ **æŒ‡æ•°é€€é¿** æˆ– **å›ºå®šé—´éš”**ï¼Œé¿å…â€œå¤±å»ç«äº‰â€å¯¼è‡´é¢‘ç¹è¯·æ±‚ã€‚  
- **ç»­æœŸ**ï¼šè‹¥ä¸šåŠ¡æ‰§è¡Œæ—¶é—´å¯èƒ½è¶…è¿‡ 30 ç§’ï¼Œå¯åœ¨ä¸šåŠ¡çº¿ç¨‹å†…å‘¨æœŸæ€§ `PEXPIRE` å»¶é•¿è¿‡æœŸæ—¶é—´ï¼Œæˆ–ä½¿ç”¨ä¸“é—¨çš„â€œç»­æœŸå®ˆæŠ¤çº¿ç¨‹â€ã€‚  
- **å¼‚å¸¸ä¿æŠ¤**ï¼šä¸šåŠ¡å±‚åœ¨ `finally` å—ä¸­ä¿è¯ `release` è„šæœ¬ä¸€å®šè¢«è°ƒç”¨ã€‚  

### 2.6 é”™è¯¯ä¸é˜²æŠ¤

| åœºæ™¯ | é—®é¢˜ | é˜²æŠ¤ |
|------|------|------|
| 1ï¸âƒ£ è¿›ç¨‹å´©æºƒåæœªé‡Šæ”¾é” | è¿‡æœŸæ—¶é—´è¶³å¤ŸçŸ­ï¼Œé”è‡ªç„¶å¤±æ•ˆ | è®¾å®šåˆç†è¿‡æœŸï¼Œç›‘æ§å¼‚å¸¸ |
| 2ï¸âƒ£ ä¸šåŠ¡è¶…æ—¶å¯¼è‡´é”æœªåŠæ—¶é‡Šæ”¾ | è¿‡æœŸæ—¶é—´è¿‡é•¿å¯¼è‡´é”é•¿æœŸå ç”¨ | ç»“åˆä¸šåŠ¡è¶…æ—¶è®¾ç½®é”è¿‡æœŸ |
| 3ï¸âƒ£ æœåŠ¡å™¨æ—¶é—´æ¼‚ç§» | é”è¿‡æœŸæ—¶é—´åŸºäºæœåŠ¡ç«¯æ—¶é’Ÿ | ä¾èµ– Redis å•æœºæ—¶é’Ÿï¼Œé›†ç¾¤æ—¶ä½¿ç”¨ NTP åŒæ­¥ |
| 4ï¸âƒ£ å¹¶å‘è§£é” | æœªç”¨ Lua è„šæœ¬è§£é” | ä½¿ç”¨ `GET+DEL` Lua åŸå­æ“ä½œ |
| 5ï¸âƒ£ é”ç«äº‰å¯¼è‡´æ— é”çŠ¶æ€ | å…¶ä»–è¿›ç¨‹æŒæœ‰é” | é‡‡ç”¨é‡è¯• + backoff æˆ–åˆ†å¸ƒå¼åè°ƒï¼ˆå¦‚ RedLockï¼‰ |

---

## 3ï¸âƒ£ æ€»ç»“ï¼šä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€å¥—â€œæœ€ä¼˜â€å®ç°ï¼Ÿ

1. **åŸå­æ€§**ï¼šé€šè¿‡ Redis Lua è„šæœ¬ï¼Œæ‰€æœ‰å…³é”®æ­¥éª¤ï¼ˆæ£€æŸ¥+æ“ä½œï¼‰éƒ½åœ¨åŒä¸€åŸå­äº‹åŠ¡å†…å®Œæˆã€‚  
2. **é˜²æ­»é”**ï¼šé”è‡ªå¸¦è¿‡æœŸæ—¶é—´ï¼Œå³ä½¿è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œé”ä¹Ÿä¼šåœ¨é™å®šæ—¶é—´åè‡ªåŠ¨å¤±æ•ˆã€‚  
3. **å¯é æ€§**ï¼šå”¯ä¸€æ ‡è¯†é˜²æ­¢è¯¯è§£é”ï¼Œä¸”è„šæœ¬ç¡®ä¿åªæœ‰é”æ‰€æœ‰è€…èƒ½è§£é”ã€‚  
4. **æ€§èƒ½**ï¼šRedis å•æœºå†…å­˜æ“ä½œæ¯«ç§’çº§ï¼Œå‡ ä¹ä¸æˆä¸ºç³»ç»Ÿç“¶é¢ˆã€‚  
5. **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥è½»æ¾è¿ç§»åˆ° Redis Clusterã€Sentinel æˆ–ä½¿ç”¨ç°æˆçš„ Redisson ç­‰é«˜é˜¶æ¡†æ¶ã€‚  

> **å®æˆ˜å»ºè®®**  
> - **ç”Ÿäº§ç¯å¢ƒ**ï¼šå»ºè®®ä½¿ç”¨ Redis **Cluster** æˆ– **Sentinel**ï¼Œå¹¶ç»“åˆ **RedLock** æˆ– **Redisson** ä½œä¸ºå®‰å…¨å±‚ã€‚  
> - **å¼€å‘ & æµ‹è¯•**ï¼šç›´æ¥ä½¿ç”¨ä¸Šè¿° Lua è„šæœ¬å³å¯ï¼Œè½»é‡ã€æ˜“ç»´æŠ¤ã€‚  
> - **ç›‘æ§**ï¼šè®°å½•é”ç”³è¯·å¤±è´¥æ¬¡æ•°ã€é”æŒæœ‰æ—¶é•¿ã€è¿‡æœŸæ¬¡æ•°ç­‰æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸ã€‚  

---

### å…³é”®ä»£ç é€Ÿè§ˆ

```python
# 1. åŠ é”
acquire_script = """
if redis.call('set', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) then
    return 1
else
    return 0
end
"""

# 2. è§£é”
release_script = """
if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('del', KEYS[1])
else
    return 0
end
"""

# ä½¿ç”¨
r.eval(acquire_script, 1, lock_key, unique_val, expire_ms)
r.eval(release_script, 1, lock_key, unique_val)
```

---

## ç»“è¯­

Redis çš„ `SET NX PX` ç»“åˆ Lua è„šæœ¬ï¼Œæä¾›äº† **è½»é‡ã€åŸå­ã€å¯é ** çš„åˆ†å¸ƒå¼é”å®ç°ã€‚æ— è®ºæ˜¯å•æœºè¿˜æ˜¯é›†ç¾¤ï¼Œéƒ½æ˜¯åœ¨ä¸šåŠ¡ä¸­å¿«é€Ÿå¼•å…¥é”åŠŸèƒ½çš„é¦–é€‰æ–¹æ¡ˆã€‚æŒæ¡äº†è¿™å¥—æ€è·¯ï¼Œä½ å³å¯åœ¨ä»»ä½•è¯­è¨€ï¼ˆPythonã€Javaã€Goã€Node ç­‰ï¼‰ä¸­å®ç°å®‰å…¨ã€å¯æ‰©å±•çš„åˆ†å¸ƒå¼é”ã€‚ç¥ä½ ç¼–ç æ„‰å¿« ğŸš€!